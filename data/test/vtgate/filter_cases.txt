# No where clause
"select id from user"
{
  "Original": "select id from user",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user"
  }
}

# Single table unique vindex route
"select id from user where user.id = 5"
{
  "Original": "select id from user where user.id = 5",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where user.id = 5",
    "Vindex": "user_index",
    "Values": 5
  }
}

# Multi-table unique vindex constraint
"select user_extra.id from user join user_extra on user.id = user_extra.user_id where user.id = 5"
{
  "Original": "select user_extra.id from user join user_extra on user.id = user_extra.user_id where user.id = 5",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select user_extra.id from user join user_extra on user.id = user_extra.user_id where user.id = 5",
    "Vindex": "user_index",
    "Values": 5
  }
}

# Multi-table unique vindex constraint on right table
"select user_extra.id from user join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5"
{
  "Original": "select user_extra.id from user join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select user_extra.id from user join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5",
    "Vindex": "user_index",
    "Values": 5
  }
}

# Multi-table unique vindex constraint on left table of left join
"select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user.id = 5"
{
  "Original": "select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user.id = 5",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user.id = 5",
    "Vindex": "user_index",
    "Values": 5
  }
}

# Multi-table unique vindex constraint on left-joined right table
"select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5"
{
  "Original": "select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select user_extra.id from user left join user_extra on user.id = user_extra.user_id where user_extra.user_id = 5"
  }
}

# Multi-route unique vindex constraint
"select user_extra.id from user join user_extra on user.col = user_extra.col where user.id = 5"
{
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user.id = 5",
  "Instructions": {
    "Left": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user where user.id = 5",
      "Vindex": "user_index",
      "Values": 5
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra where user_extra.col = :col",
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# Multi-route unique vindex route on both routes
"select user_extra.id from user join user_extra on user.col = user_extra.col where user.id = 5 and user_extra.user_id = 5"
{
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user.id = 5 and user_extra.user_id = 5",
  "Instructions": {
    "Left": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user where user.id = 5",
      "Vindex": "user_index",
      "Values": 5
    },
    "Right": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra where user_extra.col = :col and user_extra.user_id = 5",
      "Vindex": "user_index",
      "Values": 5,
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# Multi-route with cross-route constraint
"select user_extra.id from user join user_extra on user.col = user_extra.col where user_extra.user_id = user.col"
{
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user_extra.user_id = user.col",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user"
    },
    "Right": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra where user_extra.col = :col and user_extra.user_id = :col",
      "Vindex": "user_index",
      "Values": ":col",
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# Multi-route with non-route constraint, should use first route.
"select user_extra.id from user join user_extra on user.col = user_extra.col where 1 = 1"
{
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where 1 = 1",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user where 1 = 1"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra where user_extra.col = :col",
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# Route with multiple route constraints, SelectIN is the best constraint.
"select id from user where user.col = 5 and user.id in (1, 2)"
{
  "Original": "select id from user where user.col = 5 and user.id in (1, 2)",
  "Instructions": {
    "PlanID": "SelectIN",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where user.col = 5 and user.id in ::_vals",
    "Vindex": "user_index",
    "Values": [
      1,
      2
    ]
  }
}

# Route with multiple route constraints, SelectEqual is the best constraint.
"select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'"
{
  "Original": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'",
  "Instructions": {
    "PlanID": "SelectEqual",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'",
    "Vindex": "name_user_map",
    "Values": "aa"
  }
}

# Route with multiple route constraints, SelectEqualUnique is the best constraint.
"select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1"
{
  "Original": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1",
    "Vindex": "user_index",
    "Values": 1
  }
}

# Route with multiple route constraints, SelectEqualUnique is the best constraint, order reversed.
"select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5"
{
  "Original": "select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5",
    "Vindex": "user_index",
    "Values": 1
  }
}

# Route with OR and AND clause, must parenthesize correctly.
"select id from user where user.id = 1 or user.name = 'aa' and user.id in (1, 2)"
{
  "Original": "select id from user where user.id = 1 or user.name = 'aa' and user.id in (1, 2)",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from user where (user.id = 1 or user.name = 'aa' and user.id in (1, 2))"
  }
}

# Unsharded route
"select main1.id from user join main1 where main1.id = user.id"
{
  "Original": "select main1.id from user join main1 where main1.id = user.id",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.id from user"
    },
    "Right": {
      "PlanID": "SelectUnsharded",
      "Keyspace": {
        "Name": "main",
        "Sharded": false
      },
      "Query": "select main1.id from main1 where main1.id = :id",
      "JoinVars": {
        "id": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "id": 0
    }
  }
}
