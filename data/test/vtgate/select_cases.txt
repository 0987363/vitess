# No column referenced
"select 1 from user"
{
  "Original": "select 1 from user",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select 1 from user"
  }
}

# RHS route referenced
"select user_extra.id from user join user_extra"
{
  "Original": "select user_extra.id from user join user_extra",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select 1 from user"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra"
    },
    "Cols": [
      1
    ]
  }
}

# Both routes referenced
"select user.col, user_extra.id from user join user_extra"
{
  "Original": "select user.col, user_extra.id from user join user_extra",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra"
    },
    "Cols": [
      -1,
      1
    ]
  }
}

# Expression with single-route reference
"select user.col, user_extra.id + user_extra.col from user join user_extra"
{
  "Original": "select user.col, user_extra.id + user_extra.col from user join user_extra",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col from user"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id + user_extra.col from user_extra"
    },
    "Cols": [
      -1,
      1
    ]
  }
}

# Jumbled references
"select user.col, user_extra.id, user.col2 from user join user_extra"
{
  "Original": "select user.col, user_extra.id, user.col2 from user join user_extra",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col, user.col2 from user"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.id from user_extra"
    },
    "Cols": [
      -1,
      1,
      -2
    ]
  }
}

# Aggregate on unsharded
"select count(*), col from main1"
{
  "Original": "select count(*), col from main1",
  "Instructions": {
    "PlanID": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "Query": "select count(*), col from main1"
  }
}

# Aggregate on unique sharded
"select count(*), col from user where id = 1"
{
  "Original": "select count(*), col from user where id = 1",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select count(*), col from user where id = 1",
    "Vindex": "user_index",
    "Values": 1
  }
}

# Aggregate on sharded with colvindex
"select count(*), id from user"
{
  "Original": "select count(*), id from user",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select count(*), id from user"
  }
}

# Non-aggregate function on sharded with no colvindex
"select fun(1), col from user"
{
  "Original": "select fun(1), col from user",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select fun(1), col from user"
  }
}

# Distinct
"select distinct col, id from user"
{
  "Original": "select distinct col, id from user",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select distinct col, id from user"
  }
}

# Group by unsharded
"select col1, col2 from main1 group by col2"
{
  "Original": "select col1, col2 from main1 group by col2",
  "Instructions": {
    "PlanID": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "Query": "select col1, col2 from main1 group by col2"
  }
}

# Group by on unique sharded
"select col1, col2 from user where id = 1 group by col2"
{
  "Original": "select col1, col2 from user where id = 1 group by col2",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select col1, col2 from user where id = 1 group by col2",
    "Vindex": "user_index",
    "Values": 1
  }
}

# Group by on unique vindex
"select col1, id from user group by id"
{
  "Original": "select col1, id from user group by id",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select col1, id from user group by id"
  }
}

# HAVING multi-route
"select user.col1 as a, user.col2, user_extra.col3 from user join user_extra having 1 = 1 and a = 1 and a = user.col2 and user_extra.col3 = 1"
{
  "Original": "select user.col1 as a, user.col2, user_extra.col3 from user join user_extra having 1 = 1 and a = 1 and a = user.col2 and user_extra.col3 = 1",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col1 as a, user.col2 from user having 1 = 1 and a = 1 and a = user.col2"
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.col3 from user_extra having user_extra.col3 = 1"
    },
    "Cols": [
      -1,
      -2,
      1
    ]
  }
}

# ORDER BY
"select user.col1 as a, user.col2, music.col3 from user join music on user.id = music.id where user.id = 1 order by a asc, user.col2 desc, music.col3 asc"
{
  "Original": "select user.col1 as a, user.col2, music.col3 from user join music on user.id = music.id where user.id = 1 order by a asc, user.col2 desc, music.col3 asc",
  "Instructions": {
    "Left": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user.col1 as a, user.col2, user.id from user where user.id = 1 order by a asc, user.col2 desc",
      "Vindex": "user_index",
      "Values": 1
    },
    "Right": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select music.col3 from music where music.id = :id order by music.col3 asc",
      "Vindex": "music_user_map",
      "Values": ":id",
      "JoinVars": {
        "id": {}
      }
    },
    "Cols": [
      -1,
      -2,
      1
    ],
    "Vars": {
      "id": 2
    }
  }
}

# LIMIT
"select col1 from user where id = 1 limit 1"
{
  "Original": "select col1 from user where id = 1 limit 1",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select col1 from user where id = 1 limit 1",
    "Vindex": "user_index",
    "Values": 1
  }
}

# subquery
"select u.m from user_extra join user u where u.id in (select m2 from user where user.id = u.id and user_extra.col = user.col) and u.id in (user_extra.col, 1)"
{
  "Original": "select u.m from user_extra join user u where u.id in (select m2 from user where user.id = u.id and user_extra.col = user.col) and u.id in (user_extra.col, 1)",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.col from user_extra"
    },
    "Right": {
      "PlanID": "SelectIN",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select u.m from user as u where u.id in (select m2 from user where user.id = u.id and user.col = :col) and u.id in ::_vals",
      "Vindex": "user_index",
      "Values": [
        ":col",
        1
      ],
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# nested subquery
"select u.m from user_extra join user u where u.id in (select m2 from user where user.id = u.id and user_extra.col = user.col and user.id in (select m3 from user_extra where user_extra.user_id = user.id)) and u.id in (user_extra.col, 1)"
{
  "Original": "select u.m from user_extra join user u where u.id in (select m2 from user where user.id = u.id and user_extra.col = user.col and user.id in (select m3 from user_extra where user_extra.user_id = user.id)) and u.id in (user_extra.col, 1)",
  "Instructions": {
    "Left": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select user_extra.col from user_extra"
    },
    "Right": {
      "PlanID": "SelectIN",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select u.m from user as u where u.id in (select m2 from user where user.id = u.id and user.col = :col and user.id in (select m3 from user_extra where user_extra.user_id = user.id)) and u.id in ::_vals",
      "Vindex": "user_index",
      "Values": [
        ":col",
        1
      ],
      "JoinVars": {
        "col": {}
      }
    },
    "Cols": [
      1
    ],
    "Vars": {
      "col": 0
    }
  }
}

# subquery in FROM
"select id from (select id from user where id = 5) as t"
{
  "Original": "select id from (select id from user where id = 5) as t",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select id from (select id from user where id = 5) as t",
    "Vindex": "user_index",
    "Values": 5
  }
}

# subquery in FROM with join
"select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.user_id"
{
  "Original": "select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.user_id",
  "Instructions": {
    "PlanID": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.user_id",
    "Vindex": "user_index",
    "Values": 5
  }
}

# subquery in FROM, RHS of join
"select t.id from user_extra join (select id from user where id = 5) as t on t.id = user_extra.user_id"
{
  "Original": "select t.id from user_extra join (select id from user where id = 5) as t on t.id = user_extra.user_id",
  "Instructions": {
    "PlanID": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "Query": "select t.id from user_extra join (select id from user where id = 5) as t on t.id = user_extra.user_id"
  }
}

# subquery in FROM with cross-shard join
"select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.col"
{
  "Original": "select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.col",
  "Instructions": {
    "Left": {
      "PlanID": "SelectEqualUnique",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select t.id from (select id from user where id = 5) as t",
      "Vindex": "user_index",
      "Values": 5
    },
    "Right": {
      "PlanID": "SelectScatter",
      "Keyspace": {
        "Name": "user",
        "Sharded": true
      },
      "Query": "select 1 from user_extra where user_extra.col = :id",
      "JoinVars": {
        "id": {}
      }
    },
    "Cols": [
      -1
    ],
    "Vars": {
      "id": 0
    }
  }
}
